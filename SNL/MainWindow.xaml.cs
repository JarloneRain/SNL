using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace SNL {
    public partial class MainWindow : Window {
        internal enum 编译状态Enum {
            请先开始编译,
            词法分析出错,
            词法分析完成,
            语法分析出错,
            语法分析完成,
            语义分析出错,
            语义分析完成,
        }
        编译状态Enum _编译状态;
        internal 编译状态Enum 编译状态 {
            get { return _编译状态; }
            set { _编译状态 = value; 文本块编译状态.Text = _编译状态.ToString(); }
        }
        internal List<Token> TokenList { get; set; } = new();
        internal 语法树? 语法树;

        public MainWindow() {
            InitializeComponent();
            文本框代码.Text = "program bubble {程序头 程序名标识符}\r\n    var\r\n    integer i,j,num;\r\n    array[1..20] of integer a;\r\n    procedure q(integer num);\r\n        var\r\n        integer i,j,k;\r\n        integer t;\r\n    begin\r\n        i:=1;\r\n        j:=1;\r\n        while i < num do\r\n            j:=num-i+1;\r\n            k:=1;\r\n            while k<j do\r\n                if a[k+1] < a[k] then \r\n                    t:=a[k];\r\n                    a[k]:=a[k+1];\r\n                    a[k+1]:=t\r\n                else \r\n                    t:=0\r\n                fi;\r\n                k:=k+1\r\n            endwh;\r\n            i:=i+1\r\n        endwh\r\n    end\r\nbegin\r\n    read(num);\r\n    i:=1;\r\n    while i<(num+1) do\r\n        read(j);\r\n        a:=j;\r\n        i:=i+1\r\n    endwh;\r\n    q(num);\r\n    i:=1;\r\n    while i<(num+1) do\r\n        write(a);\r\n        i:=i+1\r\n    endwh\r\nend.";
            文本块编译状态.Text = 编译状态Enum.请先开始编译.ToString();
            //文本框编译结果.Text = "Program\r\n  ProgramHead\r\n    program 5\r\n    p 5\r\n  DeclarePart\r\n    VarDec\r\n      VarDeclaration\r\n        var 6\r\n              integer 6\r\n            i 6\r\n                j 6\r\n                    num 6\r\n                  ArrayType\r\n                    array 7\r\n                    1 7\r\n                    20 7\r\n                    of 7\r\n                      integer 7\r\n                a 7\r\n    ProcDec\r\n      ProcDeclaration\r\n        procedure 9\r\n        q 9\r\n        ( 9\r\n        ParamList\r\n          ParamDecList\r\n            Param\r\n                  integer 9\r\n              FormList\r\n                num 9\r\n        ) 9\r\n        ProcDecPart\r\n          DeclarePart\r\n            VarDec\r\n              VarDeclaration\r\n                var 10\r\n                      integer 10\r\n                    i 10\r\n                        j 10\r\n                            k 10\r\n                          integer 11\r\n                        t 11\r\n        ProcBody\r\n          ProgramBody\r\n            begin 12\r\n              Stm\r\n                i 13\r\n                AssCall\r\n                  AssignmentRest\r\n                    := 13\r\n                    Exp\r\n                      Term\r\n                        Factor\r\n                          lklklk 13\r\n                  Stm\r\n                    j 14\r\n                    AssCall\r\n                      AssignmentRest\r\n                        := 14\r\n                        Exp\r\n                          Term\r\n                            Factor\r\n                              1 14\r\n                      Stm\r\n                        LoopStm\r\n                          while 15\r\n                          Exp\r\n                            Term\r\n                              Factor\r\n                                Variable\r\n                                  i 15\r\n                          < 15\r\n                          Exp\r\n                            Term\r\n                              Factor\r\n                                Variable\r\n                                  num 15\r\n                          do 15\r\n                            Stm\r\n                              j 16\r\n                              AssCall\r\n                                AssignmentRest\r\n                                  := 16\r\n                                  Exp\r\n                                    Term\r\n                                      Factor\r\n                                        Variable\r\n                                          num 16\r\n                                    OtherTerm\r\n                                      AddOp\r\n                                        - 16\r\n                                      Exp\r\n                                        Term\r\n                                          Factor\r\n                                            Variable\r\n                                              i 16\r\n                                        OtherTerm\r\n                                          AddOp\r\n                                            + 16\r\n                                          Exp\r\n                                            Term\r\n                                              Factor\r\n                                                1 16\r\n                                Stm\r\n                                  k 17\r\n                                  AssCall\r\n                                    AssignmentRest\r\n                                      := 17\r\n                                      Exp\r\n                                        Term\r\n                                          Factor\r\n                                            1 17\r\n                                    Stm\r\n                                      LoopStm\r\n                                        while 18\r\n                                        Exp\r\n                                          Term\r\n                                            Factor\r\n                                              Variable\r\n                                                k 18\r\n                                        < 18\r\n                                        Exp\r\n                                          Term\r\n                                            Factor\r\n                                              Variable\r\n                                                j 18\r\n                                        do 18\r\n                                          Stm\r\n                                            ConditionalStm\r\n                                              if 19\r\n                                              Exp\r\n                                                Term\r\n                                                  Factor\r\n                                                    Variable\r\n                                                      a 19\r\n                                                      VariMore\r\n                                                        Exp\r\n                                                          Term\r\n                                                            Factor\r\n                                                              Variable\r\n                                                                k 19\r\n                                                          OtherTerm\r\n                                                            AddOp\r\n                                                              + 19\r\n                                                            Exp\r\n                                                              Term\r\n                                                                Factor\r\n                                                                  1 19\r\n                                              < 19\r\n                                              Exp\r\n                                                Term\r\n                                                  Factor\r\n                                                    Variable\r\n                                                      a 19\r\n                                                      VariMore\r\n                                                        Exp\r\n                                                          Term\r\n                                                            Factor\r\n                                                              Variable\r\n                                                                k 19\r\n                                              then 20\r\n                                                Stm\r\n                                                  t 20\r\n                                                  AssCall\r\n                                                    AssignmentRest\r\n                                                      := 20\r\n                                                      Exp\r\n                                                        Term\r\n                                                          Factor\r\n                                                            Variable\r\n                                                              a 20\r\n                                                              VariMore\r\n                                                                Exp\r\n                                                                  Term\r\n                                                                    Factor\r\n                                                                      Variable\r\n                                                                        k 20\r\n                                                    Stm\r\n                                                      a 21\r\n                                                      AssCall\r\n                                                        AssignmentRest\r\n                                                          VariMore\r\n                                                            Exp\r\n                                                              Term\r\n                                                                Factor\r\n                                                                  Variable\r\n                                                                    k 21\r\n                                                          := 21\r\n                                                          Exp\r\n                                                            Term\r\n                                                              Factor\r\n                                                                Variable\r\n                                                                  a 21\r\n                                                                  VariMore\r\n                                                                    Exp\r\n                                                                      Term\r\n                                                                        Factor\r\n                                                                          Variable\r\n                                                                            k 21\r\n                                                                      OtherTerm\r\n                                                                        AddOp\r\n                                                                          + 21\r\n                                                                        Exp\r\n                                                                          Term\r\n                                                                            Factor\r\n                                                                              1 21\r\n                                                        Stm\r\n                                                          a 22\r\n                                                          AssCall\r\n                                                            AssignmentRest\r\n                                                              VariMore\r\n                                                                Exp\r\n                                                                  Term\r\n                                                                    Factor\r\n                                                                      Variable\r\n                                                                        k 22\r\n                                                                  OtherTerm\r\n                                                                    AddOp\r\n                                                                      + 22\r\n                                                                    Exp\r\n                                                                      Term\r\n                                                                        Factor\r\n                                                                          1 22\r\n                                                              := 22\r\n                                                              Exp\r\n                                                                Term\r\n                                                                  Factor\r\n                                                                    Variable\r\n                                                                      t 22\r\n                                              else 23\r\n                                                Stm\r\n                                                  t 23\r\n                                                  AssCall\r\n                                                    AssignmentRest\r\n                                                      := 23\r\n                                                      Exp\r\n                                                        Term\r\n                                                          Factor\r\n                                                            0 24\r\n                                              fi 24\r\n                                              Stm\r\n                                                k 25\r\n                                                AssCall\r\n                                                  AssignmentRest\r\n                                                    := 25\r\n                                                    Exp\r\n                                                      Term\r\n                                                        Factor\r\n                                                          Variable\r\n                                                            k 25\r\n                                                      OtherTerm\r\n                                                        AddOp\r\n                                                          + 25\r\n                                                        Exp\r\n                                                          Term\r\n                                                            Factor\r\n                                                              1 26\r\n                                        endwh 26\r\n                                        Stm\r\n                                          i 27\r\n                                          AssCall\r\n                                            AssignmentRest\r\n                                              := 27\r\n                                              Exp\r\n                                                Term\r\n                                                  Factor\r\n                                                    Variable\r\n                                                      i 27\r\n                                                OtherTerm\r\n                                                  AddOp\r\n                                                    + 27\r\n                                                  Exp\r\n                                                    Term\r\n                                                      Factor\r\n                                                        1 28\r\n                          endwh 28\r\n            end 29\r\n  ProgramBody\r\n    begin 31\r\n      Stm\r\n        InputStm\r\n          read 32\r\n          ( 32\r\n          num 32\r\n          ) 32\r\n          Stm\r\n            i 33\r\n            AssCall\r\n              AssignmentRest\r\n                := 33\r\n                Exp\r\n                  Term\r\n                    Factor\r\n                      1 33\r\n              Stm\r\n                LoopStm\r\n                  while 34\r\n                  Exp\r\n                    Term\r\n                      Factor\r\n                        Variable\r\n                          i 34\r\n                  < 34\r\n                  Exp\r\n                    Term\r\n                      Factor\r\n                        ( 34\r\n                        Exp\r\n                          Term\r\n                            Factor\r\n                              Variable\r\n                                num 34\r\n                          OtherTerm\r\n                            AddOp\r\n                              + 34\r\n                            Exp\r\n                              Term\r\n                                Factor\r\n                                  1 34\r\n                        ) 34\r\n                  do 34\r\n                    Stm\r\n                      InputStm\r\n                        read 35\r\n                        ( 35\r\n                        j 35\r\n                        ) 35\r\n                        Stm\r\n                          a 36\r\n                          AssCall\r\n                            AssignmentRest\r\n                              VariMore\r\n                                Exp\r\n                                  Term\r\n                                    Factor\r\n                                      Variable\r\n                                        i 36\r\n                              := 36\r\n                              Exp\r\n                                Term\r\n                                  Factor\r\n                                    Variable\r\n                                      j 36\r\n                            Stm\r\n                              i 37\r\n                              AssCall\r\n                                AssignmentRest\r\n                                  := 37\r\n                                  Exp\r\n                                    Term\r\n                                      Factor\r\n                                        Variable\r\n                                          i 37\r\n                                    OtherTerm\r\n                                      AddOp\r\n                                        + 37\r\n                                      Exp\r\n                                        Term\r\n                                          Factor\r\n                                            1 38\r\n                  endwh 38\r\n                  Stm\r\n                    q 39\r\n                    AssCall\r\n                      CallStmRest\r\n                        ( 39\r\n                        ActParamList\r\n                          Exp\r\n                            Term\r\n                              Factor\r\n                                Variable\r\n                                  num 39\r\n                        ) 39\r\n                      Stm\r\n                        i 40\r\n                        AssCall\r\n                          AssignmentRest\r\n                            := 40\r\n                            Exp\r\n                              Term\r\n                                Factor\r\n                                  1 40\r\n                          Stm\r\n                            LoopStm\r\n                              while 41\r\n                              Exp\r\n                                Term\r\n                                  Factor\r\n                                    Variable\r\n                                      i 41\r\n                              < 41\r\n                              Exp\r\n                                Term\r\n                                  Factor\r\n                                    ( 41\r\n                                    Exp\r\n                                      Term\r\n                                        Factor\r\n                                          Variable\r\n                                            num 41\r\n                                      OtherTerm\r\n                                        AddOp\r\n                                          + 41\r\n                                        Exp\r\n                                          Term\r\n                                            Factor\r\n                                              1 41\r\n                                    ) 41\r\n                              do 41\r\n                                Stm\r\n                                  OutputStm\r\n                                    write 42\r\n                                    ( 42\r\n                                    Exp\r\n                                      Term\r\n                                        Factor\r\n                                          Variable\r\n                                            a 42\r\n                                            VariMore\r\n                                              Exp\r\n                                                Term\r\n                                                  Factor\r\n                                                    Variable\r\n                                                      i 42\r\n                                    ) 42\r\n                                    Stm\r\n                                      i 43\r\n                                      AssCall\r\n                                        AssignmentRest\r\n                                          := 43\r\n                                          Exp\r\n                                            Term\r\n                                              Factor\r\n                                                Variable\r\n                                                  i 43\r\n                                            OtherTerm\r\n                                              AddOp\r\n                                                + 43\r\n                                              Exp\r\n                                                Term\r\n                                                  Factor\r\n                                                    1 44\r\n                              endwh 44\r\n    end 45\r\n"
            ;
        }

        private void 按钮词法分析_Click(object sender, RoutedEventArgs e) {
            try {
                TokenList = 词法.分析(文本框代码.Text + "~");
                编译状态 = 编译状态Enum.词法分析完成;
                文本框编译结果.Text = "";
                foreach (Token token in TokenList) {
                    文本框编译结果.Text += $"{token}\n";
                }
            } catch (Exception ex) {
                编译状态 = 编译状态Enum.词法分析出错;
                文本框编译结果.Text = ex.Message;
            }
        }

        private void 按钮语法分析_Click(object sender, RoutedEventArgs e) {
            按钮词法分析_Click(sender, e);
            if (编译状态 != 编译状态Enum.词法分析完成) {
                MessageBox.Show("词法分析出错！");
                return;
            }
            try {
                switch (下拉语法分析方式.SelectedIndex) {
                    case 0:
                        MessageBox.Show("将开始递归下降语法分析！");
                        break;
                    case 1:
                        语法树 = 语法.分析_LL1(TokenList);
                        break;
                }
                文本框编译结果.Text = 语法树!.ToString();
                编译状态 = 编译状态Enum.语法分析完成;
            } catch (语法分析异常 ex) {
                文本框编译结果.Text = ex.Message;
            }
        }

        private void 按钮语义分析_Click(object sender, RoutedEventArgs e) {
            按钮语法分析_Click(sender, e);
            if (编译状态 != 编译状态Enum.语法分析完成) {
                MessageBox.Show("语法分析出错！");
                return;
            }
            try {
                var 语义错误列表 = 语义.分析(语法树!);
                文本框编译结果.Text = 语义错误列表.Count == 0 ? "没有语义错误" : "";
                语义错误列表.ForEach(e => 文本框编译结果.Text += $"{e}\n");
                编译状态 = 编译状态Enum.语义分析完成;
            } catch (语法分析异常 ex) {
                编译状态 = 编译状态Enum.语义分析出错;
                文本框编译结果.Text = ex.Message;
            }
        }
    }
}
